#!/usr/bin/env bash

set -euo pipefail

__list_installed_plugins() {
    # asdf plugin-list 2>/dev/null | sort
    # mise plugins 2>/dev/null | sort
    mise ls --json 2>/dev/null | jq -r 'keys|.[]|select(length > 0)' | sort
}

__list_installed_versions() {
    # asdf list $1 2>/dev/null
    mise ls $1 -i 2>/dev/null | awk '{print $2}'
}

__select_installed_version() {
    __list_installed_versions $1 | \
    fzf --tac --ansi --no-sort | \
    awk '{print $1}'
}

main() {
    local plugin=`__list_installed_plugins | fzf`
    if [ -z "$plugin" ]; then
        echo "No plugin selected"
        exit 1
    fi
    # __select_installed_version $plugin | xargs -t -r -n 1 asdf global $plugin
    local selected=`__select_installed_version $plugin`
    if [ -z "$selected" ]; then
        echo "No version selected"
        exit 1
    fi
    mise use -g $plugin@${selected}
}

main
